{% extends 'core/base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid p-0">
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold h4 mb-1">{% if form.instance.pk %}Editar Post{% else %}Novo Post{% endif %}</h2>
            <p class="text-muted small mb-0">
                Cliente: <span class="badge bg-primary">{{ cronograma_obj.cliente.nome_fantasia }}</span>
            </p>
        </div>
        <a href="{% url 'detalhes_cronograma' cronograma_obj.id %}" class="btn btn-outline-secondary btn-sm rounded-pill px-3 fw-bold">
            <i class="bi bi-arrow-left me-1"></i> Voltar
        </a>
    </div>

    <div class="card border-0 shadow-sm p-4" style="border-radius: 15px;">
        <form id="postForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="d-none">{{ form.cronograma|as_crispy_field }}</div>

            <div class="row">
                <div class="col-md-12 mb-3">{{ form.status|as_crispy_field }}</div>
            </div>

            <div class="mb-3">{{ form.titulo|as_crispy_field }}</div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold small">Data de Publicação</label>
                    {{ form.data_publicacao }} 
                </div>
                <div class="col-md-4 mb-3">{{ form.rede_social|as_crispy_field }}</div>
                <div class="col-md-4 mb-3">{{ form.formato|as_crispy_field }}</div>
            </div>

            <div class="mb-3">{{ form.legenda|as_crispy_field }}</div>
            <div class="mb-3">{{ form.briefing_arte|as_crispy_field }}</div>

            <div class="mb-4">
                <label class="form-label fw-bold text-primary">
                    <i class="bi bi-images me-2"></i>Arquivos do Post (Carrossel ou Único)
                </label>
                {{ form.arquivos_multiplos }}
                <small class="text-muted d-block mt-1">Você pode selecionar vários arquivos de uma vez.</small>
            </div>
            
            <div id="progressContainer" class="progress mb-4 d-none" style="height: 25px; border-radius: 12px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success fw-bold" role="progressbar" style="width: 0%;">0%</div>
            </div>

            <div class="d-grid">
                <button type="submit" id="btnSubmit" class="btn btn-primary py-3 fw-bold shadow-sm" style="border-radius: 12px; background: #6c5ce7; border: none;">
                    <i class="bi bi-cloud-arrow-up-fill me-2"></i>Salvar no Cronograma
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    const postForm = document.getElementById('postForm');
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.getElementById('progressContainer');
    const btnSubmit = document.getElementById('btnSubmit');

    postForm.onsubmit = function(e) {
        e.preventDefault();
        const formData = new FormData(postForm);
        const xhr = new XMLHttpRequest();

        progressContainer.classList.remove('d-none');
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando para o Dropbox...';

        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percent = (e.loaded / e.total) * 100;
                progressBar.style.width = percent.toFixed(0) + '%';
                progressBar.innerText = percent.toFixed(0) + '%';
            }
        });

        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                window.location.href = response.url;
            } else if (xhr.readyState === 4) {
                alert('Erro ao salvar o post. Verifique a conexão com o Dropbox.');
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="bi bi-cloud-arrow-up-fill me-2"></i>Tentar Novamente';
            }
        };

        xhr.open('POST', window.location.href, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.send(formData);
    };
</script>

<style>
    /* Estética e remoção de labels duplicados pelo Crispy */
    label[for="id_data_publicacao"], label[for="id_legenda"], 
    label[for="id_briefing_arte"] { display: none !important; }
    .asteriskField { display: none !important; }
    .form-control:focus { border-color: #6c5ce7; box-shadow: 0 0 0 0.2rem rgba(108, 92, 231, 0.25); }
</style>
{% endblock %}