{% extends 'core/base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid p-0">
    
    <div class="card border-0 shadow-sm mb-5" style="border-radius: 15px;">
        <div class="card-body p-4">
            <form method="post" class="row g-3 align-items-end">
                {% csrf_token %}
                <input type="hidden" name="editar_cronograma" value="1">
                
                <div class="col-md-3 col-12">{{ form_cronograma.cliente|as_crispy_field }}</div>
                <div class="col-md-3 col-12">{{ form_cronograma.titulo|as_crispy_field }}</div>
                <div class="col-md-1 col-6">{{ form_cronograma.mes|as_crispy_field }}</div>
                <div class="col-md-1 col-6">{{ form_cronograma.ano|as_crispy_field }}</div>
                <div class="col-md-2 col-6">{{ form_cronograma.data_inicio|as_crispy_field }}</div>
                <div class="col-md-2 col-6">{{ form_cronograma.data_fim|as_crispy_field }}</div>
                
                <div class="col-12 text-end mt-3">
                    <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">
                        <i class="bi bi-check-lg me-1"></i> Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4 px-1">
        <div class="d-flex align-items-center">
            <a href="{% url 'listar_cronogramas' %}" class="btn btn-light rounded-circle shadow-sm me-3" title="Voltar para Lista">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div>
                <h3 class="fw-bold h5 mb-0">Preview do Feed</h3>
                <p class="text-muted small mb-0">Visualização Mobile (3x3)</p>
            </div>
        </div>
        
        <div class="d-flex gap-2">
            <a href="{% url 'gerar_pdf_cronograma' cronograma.id %}" target="_blank" class="btn btn-outline-danger rounded-pill px-3 fw-bold shadow-sm" title="Gerar PDF para Cliente">
                <i class="bi bi-file-earmark-pdf me-1"></i> PDF
            </a>
            
            <a href="{% url 'cadastrar_post' %}?cronograma={{ cronograma.id }}" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" style="background: #6c5ce7; border: none;">
                <i class="bi bi-plus-lg me-1"></i> Post
            </a>
        </div>
    </div>

    <div class="d-flex flex-wrap align-items-start gap-4">
    
    {% if posts %}
        {% for post in posts %}
            
            {% if forloop.counter0|divisibleby:9 %}
            <div class="mobile-frame bg-white shadow-lg p-3 flex-shrink-0">
                <div class="d-flex justify-content-between align-items-center mb-3 px-1 text-muted">
                    <small class="fw-bold">{{ cronograma.cliente.nome_fantasia|lower }}</small>
                    <i class="bi bi-three-dots"></i>
                </div>
                <div class="row g-1"> 
            {% endif %}

            <div class="col-4">
                <div class="position-relative overflow-hidden" style="aspect-ratio: 3/4; background: #f0f0f0; border-radius: 4px;">
                    <a href="{% url 'editar_post' post.pk %}" class="d-block w-100 h-100 text-decoration-none">
                        
                        {% if post.temp_img_url %}
                            {% if post.is_video %}
                                <video src="{{ post.temp_img_url }}#t=0.5" class="w-100 h-100 bg-black" style="object-fit: cover;" controls playsinline preload="metadata"></video>
                                <div class="position-absolute top-0 end-0 m-1 text-white pointer-events-none">
                                    <i class="bi bi-camera-video-fill shadow-sm"></i>
                                </div>
                            {% else %}
                                <img src="{{ post.temp_img_url }}" class="w-100 h-100" style="object-fit: cover; transition: transform 0.3s;">
                            {% endif %}
                        {% else %}
                            <div class="w-100 h-100 d-flex flex-column align-items-center justify-content-center text-muted">
                                <i class="bi bi-image fs-4 opacity-50"></i>
                                <span class="small mt-1 text-truncate px-1" style="font-size: 0.6rem;">{{ post.titulo }}</span>
                            </div>
                        {% endif %}

                        <div class="post-overlay position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-between p-2">
                            <div class="d-flex justify-content-end pointer-events-none">
                                {% if post.status == 'aprovado' %}
                                    <span class="status-dot bg-success" title="Aprovado"></span>
                                {% elif post.status == 'revisao' %}
                                    <span class="status-dot bg-warning" title="Em Revisão"></span>
                                {% elif post.status == 'postado' %}
                                    <span class="status-dot bg-primary" title="Postado"></span>
                                {% else %}
                                    <span class="status-dot bg-secondary" title="Planejamento"></span>
                                {% endif %}
                            </div>
                            <div class="text-white text-shadow small fw-bold text-center pointer-events-none">
                                {{ post.data_publicacao|date:"d/m" }}
                            </div>
                        </div>
                    </a>
                </div>
            </div>

            {% if forloop.counter|divisibleby:9 or forloop.last %}
                </div> <div class="d-flex justify-content-around mt-3 text-muted fs-5">
                    <i class="bi bi-house-door-fill text-dark"></i>
                    <i class="bi bi-search"></i>
                    <i class="bi bi-plus-square"></i>
                    <i class="bi bi-heart"></i>
                    <i class="bi bi-person-circle"></i>
                </div>
            </div>
            {% endif %}

        {% endfor %}

    {% else %}
        <div class="col-12 text-center py-5">
            <div class="mobile-frame bg-white shadow-sm mx-auto p-5 d-flex flex-column align-items-center justify-content-center" style="min-height: 300px; max-width: 380px;">
                <i class="bi bi-grid-3x3 text-muted opacity-25" style="font-size: 3rem;"></i>
                <p class="text-muted mt-3">O feed está vazio.</p>
                <a href="{% url 'cadastrar_post' %}?cronograma={{ cronograma.id }}" class="btn btn-sm btn-outline-primary rounded-pill mt-2">
                    Começar Planejamento
                </a>
            </div>
        </div>
    {% endif %}

    </div> </div>

<style>
    /* Estilo "Celular" */
    .mobile-frame {
        width: 100%;
        max-width: 380px; /* Largura de um iPhone grande */
        border-radius: 35px;
        border: 1px solid #e0e0e0;
    }
    
    /* Efeitos de Hover e Overlay */
    .post-overlay {
        background: linear-gradient(to bottom, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%);
        opacity: 0.8;
        transition: 0.2s;
        pointer-events: none; /* Deixa clicar no vídeo/imagem abaixo se precisar */
    }
    .col-4:hover .post-overlay { opacity: 1; }

    /* Utilitários Visuais */
    .status-dot {
        width: 8px; height: 8px; border-radius: 50%; display: block; box-shadow: 0 0 0 1px white;
    }
    .text-shadow { text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
    .pointer-events-none { pointer-events: none; }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Mantemos o script caso queiramos adicionar botões de exclusão rápida no futuro
function confirmarExclusaoPost(url) {
    Swal.fire({
        title: 'Apagar Post?',
        text: "Essa ação mandará o post para a lixeira.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, apagar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) { window.location.href = url; }
    })
}
</script>
{% endblock %}